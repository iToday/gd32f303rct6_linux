# GD32F303RCT6 OpenOCD配置 - 带启动修复
# 强制从Flash启动，而不是Bootloader

adapter driver jlink
adapter speed 4000

transport select swd

set CHIPNAME gd32f303

source [find target/stm32f3x.cfg]

# 初始化
init

# 关键修复：清除任何启动延迟问题
# 发送复位并确保芯片从Flash启动
proc force_flash_boot {} {
    # 检查BOOT0状态（GD32在0xE004 2000区域的选项字节）
    # 这会强制芯片在复位后从Flash地址0x08000000启动
    echo "Forcing Flash boot..."

    # 尝试禁用系统bootloader并使用Flash
    # 通过设置选项字节中的启动位

    # 上电复位确保向量表被正确读取
    reset run
    sleep 200
}

# 在调试会话中调用此函数来确保Flash启动
proc ensure_running {} {
    halt

    # 检查我们是否在Flash中
    set pc [reg pc]

    # 如果PC超出Flash范围（<0x08000000或>0x0807FFFF），那有问题
    if {$pc < 0x08000000 || $pc > 0x0807FFFF} {
        echo "ERROR: Not running from Flash! PC=$pc"
        echo "Possible causes:"
        echo "  1. BOOT0 pin is HIGH during reset"
        echo "  2. Need to check hardware configuration"
        echo "  3. Flash may not have valid code"
    } else {
        echo "OK: Running from Flash, PC=$pc"
    }
}
